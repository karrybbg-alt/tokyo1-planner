// --- Wallet Logic ---
const expenseList = document.getElementById('expenseList');
let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
let currentPhoto = null; // base64 string

// Current exchange rate as of December 30, 2025
// Source: Xe.com, Forbes Advisor, Bloomberg (mid-market rate)
const HKD_RATE = 0.0497;  // 1 JPY ≈ 0.0497 HKD

// Optional: Display the current rate in UI (add the HTML in Step 2)
function updateRateDisplay() {
    const rateDisplay = document.getElementById('currentRateDisplay');
    if (rateDisplay) {
        rateDisplay.textContent = `匯率: 1 ¥ = HK$ ${HKD_RATE.toFixed(4)} (2025年12月30日)`;
    }
}

// Load existing expenses on page load
function loadExpenses() {
    expenseList.innerHTML = '';
    
    // Sort expenses: newest first
    expenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    expenses.forEach((exp, index) => {
        const item = document.createElement('div');
        item.className = 'card p-3 flex justify-between items-center';
        item.innerHTML = `
            <div>
                <div class="font-medium">${exp.name}</div>
                <div class="text-xs text-gray-500">
                    ${new Date(exp.timestamp).toLocaleDateString('zh-HK')}
                </div>
                <div class="text-xs text-gray-500">
                    ¥${exp.price.toLocaleString()} → HK$${exp.hkd.toFixed(1)}
                </div>
            </div>
            <div class="flex items-center gap-3">
                ${exp.photo ? `<img src="${exp.photo}" class="w-10 h-10 object-cover rounded" />` : ''}
                <button onclick="deleteExpense(${index})" class="text-red-400 text-xs">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        expenseList.appendChild(item);
    });
    updateTotal();
    updateRateDisplay(); // Update rate text when loading
}

function updateTotal() {
    const totalJPY = expenses.reduce((sum, exp) => sum + exp.price, 0);
    const totalHKD = expenses.reduce((sum, exp) => sum + exp.hkd, 0);
   
    const summary = document.createElement('div');
    summary.className = 'card p-4 mt-4 bg-gray-900/50 text-center';
    summary.innerHTML = `
        <div class="text-sm text-gray-400">本次旅行總花費</div>
        <div class="text-2xl font-bold gold-text mt-1">¥${totalJPY.toLocaleString()}</div>
        <div class="text-lg gold-text">HK$${totalHKD.toFixed(1)}</div>
    `;
   
    // Replace existing summary if any
    const existing = expenseList.querySelector('.summary-total');
    if (existing) existing.remove();
    summary.classList.add('summary-total');
    expenseList.appendChild(summary);
}

function addExpense() {
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('itemPrice').value);
   
    if (!name || isNaN(price) || price <= 0) {
        alert('請輸入有效的品項名稱與金額');
        return;
    }
   
    const hkd = price * HKD_RATE;
   
    const expense = {
        name,
        price,
        hkd,
        photo: currentPhoto || null,
        timestamp: new Date().toISOString()
    };
   
    expenses.push(expense);
    localStorage.setItem('expenses', JSON.stringify(expenses));
   
    // Reset form
    document.getElementById('itemName').value = '';
    document.getElementById('itemPrice').value = '';
    document.getElementById('photoInput').value = '';
    currentPhoto = null;
    document.getElementById('photoStatus').textContent = 'No Photo';
   
    loadExpenses();
}

function deleteExpense(index) {
    if (confirm('確定要刪除這筆紀錄？')) {
        expenses.splice(index, 1);
        localStorage.setItem('expenses', JSON.stringify(expenses));
        loadExpenses();
    }
}

function processImage(event) {
    const file = event.target.files[0];
    if (!file) return;
   
    const reader = new FileReader();
    reader.onload = function(e) {
        currentPhoto = e.target.result; // base64
        document.getElementById('photoStatus').textContent = 'Photo Selected ✓';
    };
    reader.readAsDataURL(file);
}

// Real-time JPY → HKD converter
document.getElementById('jpyInput').addEventListener('input', function(e) {
    const jpy = parseFloat(e.target.value) || 0;
    const hkd = jpy * HKD_RATE;
        // Current exchange rate as of December 30, 2025 (source: Xe.com, Forbes, Bloomberg)
const HKD_RATE = 0.0497;  // 1 JPY ≈ 0.0497 HKD
        <div id="currentRateDisplay" class="text-xs text-gray-500 text-center mt-4 mb-4">
    匯率: 1 ¥ = HK$ 0.0497 (2025年12月30日)
</div>
    document.getElementById('hkdResult').textContent = `HK$ ${hkd.toFixed(1)}`;
});

// Initialize on load
loadExpenses();

// Memo and checklist code remains unchanged...
const memoArea = document.getElementById('memoArea');
const memoLinks = document.getElementById('memoLinks');
memoArea.addEventListener('input', function() {
    const text = memoArea.value;
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const urls = text.match(urlRegex) || [];
   
    memoLinks.innerHTML = '';
    urls.forEach(url => {
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.className = 'inline-block px-2 py-1 bg-gray-800 text-yellow-400 text-xs rounded hover:bg-gray-700';
        link.textContent = url.length > 40 ? url.substring(0,37) + '...' : url;
        memoLinks.appendChild(link);
    });
});

const checklist = document.getElementById('checklist');
function addChecklistItem(text, checked = false) {
    const id = 'check-' + Date.now();
    const item = document.createElement('div');
    item.className = 'flex items-center gap-2';
    item.innerHTML = `
        <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} class="w-4 h-4 accent-yellow-600">
        <label for="${id}" class="text-sm">${text}</label>
    `;
    checklist.appendChild(item);
}

const defaultChecklist = [
    '護照 + 簽證 (如需要)',
    '信用卡 + 現金',
    '行動電源',
    '防水防滑雪靴',
    '溫暖內層衣物',
    'Visit Japan Web QR code',
    '迪士尼門票預約'
];
defaultChecklist.forEach(item => addChecklistItem(item));
